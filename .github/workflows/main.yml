name: Deploy Application

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Configure npm and Install PM2
        run: |
          mkdir "${HOME}/.npm-global"
          npm config set prefix "${HOME}/.npm-global"
          export PATH="${HOME}/.npm-global/bin:${PATH}"
          npm install -g pm2
          npm install
          npm audit fix --force
          npm audit

      - name: Build Project
        run: |
          npm run build

      - name: Restart Application with PM2
        run: |
          pm2 restart all || { echo "Failed to restart application"; exit 1; }
